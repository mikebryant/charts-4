suite: Test the Readiness Probe Configuration
templates:
  - templates/daemonset.yaml
  - templates/deployment.yaml
kubernetesProvider:
  scheme:
    "v1/Node":
      gvr:
        version: "v1"
        resource: "nodes"
      namespaced: false
  objects:
  - apiVersion: v1
    kind: Node
    metadata:
      name: fakenode
    status:
      nodeInfo:
        osImage: fake-os-image
tests:
  - it: "[DaemonSet] Readiness Probe"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
             httpGet:
               host: 127.0.0.1
               path: /healthz
               port: 24483
             initialDelaySeconds: 90
             periodSeconds: 10
             failureThreshold: 9
    template: templates/daemonset.yaml

  - it: "[DelegatedAgentDeployment] Readiness Probe"
    set:
      delegatedAgentDeployment:
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            httpGet:
              host: 127.0.0.1
              path: /healthz
              port: 24483
            initialDelaySeconds: 90
            periodSeconds: 10
            failureThreshold: 9

  - it: Test setting probe delays
    set:
      daemonset:
        probes:
          initialDelay: 5
          periodDelay: 3
          failureThreshold: 10
      delegatedAgentDeployment:
        deployment:
          probes:
            initialDelay: 5
            periodDelay: 3
            failureThreshold: 10
        enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.failureThreshold
          value: 10
